---
wave: 1
depends_on: []
files_modified:
  - frontend/src/lib/components/content/ToolBlock.svelte
  - frontend/src/lib/utils/tool-params.ts
  - frontend/src/lib/utils/tool-params.test.ts
autonomous: true
must_haves:
  - Collapsed tool header shows agent__intent text when previewLine is otherwise empty
  - agent__intent does NOT appear in the expanded tool content (filtered from generateFallbackContent generic loop)
  - All existing tool-params tests continue to pass
  - New tests cover agent__intent filtering in generateFallbackContent
---

# Plan 05-02: ToolBlock `agent__intent` Display and Fallback Filter

## Objective

Surface `agent__intent` from pi tool call arguments in the collapsed tool block header as a fallback preview (when no better preview is available), and filter `agent__intent` from the generic key-value fallback in `generateFallbackContent` so it does not appear as expanded content.

## Context

Pi tool calls frequently include `agent__intent` in their `arguments` object — a human-readable description of why the tool is being called (e.g. `"Reading package.json to understand project dependencies"`). This field is currently invisible to the user.

After Phase 5's 05-01 plan:
- Pi `bash` tool calls will have `content = "$ command"` — the previewLine shows the command. `agent__intent` should only appear if `content` is empty.
- Pi `read` tool calls will have `content = "/path/to/file"` — the previewLine shows the path. `agent__intent` is again a fallback.
- Pi `edit`, `write`, `grep`, `glob`, `find` tool calls have `content = ""` — these benefit most from `agent__intent` as previewLine.

`agent__intent` is stored in `inputParams` (parsed from `toolCall.input_json`) and is already available in `ToolBlock.svelte` alongside all other params.

Two related issues:
1. **`ToolBlock.svelte` previewLine** — currently derived from `content.split("\n")[0]`. When `content` is empty, `previewLine` is also empty. Need to add `agent__intent` as a fallback.
2. **`generateFallbackContent` generic loop** — the fallback key-value loop in `tool-params.ts` dumps ALL params including `agent__intent`, so it would display `"agent__intent: Reading auth module"` in the expanded view — redundant and confusing.

These two changes are independent of the alias/expansion changes in Plan 05-01. `ToolBlock.svelte` receives `label` and `content` from the parent component; it does not care about `TOOL_ALIASES`. The `inputParams` object always contains the raw parsed `input_json`, so `agent__intent` is accessible regardless of whether the label has been aliased.

## Task 1 — Add `agent__intent` as `previewLine` Fallback in `ToolBlock.svelte`

**Type:** edit
**Files:**
- `frontend/src/lib/components/content/ToolBlock.svelte`

**Action:**

In the `<script>` section of `ToolBlock.svelte`, change the `previewLine` derivation from a simple `$derived` to a `$derived.by()` that falls back to `agent__intent` when `content` is empty.

Replace:
```typescript
  let previewLine = $derived(
    content.split("\n")[0]?.slice(0, 100) ?? "",
  );
```

With:
```typescript
  let previewLine = $derived.by(() => {
    const line = content.split("\n")[0]?.slice(0, 100) ?? "";
    if (line) return line;
    if (inputParams?.agent__intent) {
      return String(inputParams.agent__intent).slice(0, 100);
    }
    return "";
  });
```

**Important:** `inputParams` is already derived above `previewLine` in the script block. The ordering in the file is:
1. `let previewLine = ...` (line ~20)
2. `let inputParams = $derived.by(() => { ... })` (line ~24)

The `previewLine` derivation must come AFTER `inputParams`. Check the current order. If `previewLine` is currently defined before `inputParams`, swap their order so `inputParams` is derived first, then `previewLine`.

Current order in file:
- Line 20: `let previewLine = $derived(...)`
- Line 25: `let inputParams = $derived.by(() => { ... })`

After change, the order must be:
1. `let inputParams = $derived.by(() => { ... })` — moved first
2. `let previewLine = $derived.by(() => { ... })` — uses `inputParams`

The complete replacement is:

Remove both current derivations and replace with:
```typescript
  /** Parsed input parameters from structured tool call data */
  let inputParams = $derived.by(() => {
    if (!toolCall?.input_json) return null;
    try {
      return JSON.parse(toolCall.input_json);
    } catch {
      return null;
    }
  });

  let previewLine = $derived.by(() => {
    const line = content.split("\n")[0]?.slice(0, 100) ?? "";
    if (line) return line;
    if (inputParams?.agent__intent) {
      return String(inputParams.agent__intent).slice(0, 100);
    }
    return "";
  });
```

**Verify:**

- The file builds without TypeScript errors: `cd /Users/carze/Documents/personal/misc/agentsview/frontend && npx tsc --noEmit 2>&1 | head -20`
- `inputParams` is derived before `previewLine` in the script block.
- `previewLine` now references `inputParams?.agent__intent`.

**Done when:** File compiles cleanly with `inputParams` before `previewLine` and the fallback logic in place.

## Task 2 — Filter `agent__intent` from `generateFallbackContent` Generic Loop

**Type:** edit
**Files:**
- `frontend/src/lib/utils/tool-params.ts`

**Action:**

In `generateFallbackContent`, add a constant set of internal/meta params to skip, and filter the generic key-value loop with it.

Add a module-level constant immediately before `generateFallbackContent` (or inside the function — either is acceptable):

```typescript
/** Parameter keys that are pi-internal metadata, not tool input.
 *  These should not appear in the expanded content display. */
const INTERNAL_PARAMS = new Set(["agent__intent"]);
```

Then in the generic fallback loop, add the filter check. The current loop is:
```typescript
  const lines: string[] = [];
  for (const [key, value] of Object.entries(params)) {
    if (value == null || value === "") continue;
    const strVal =
      typeof value === "string"
        ? value
        : JSON.stringify(value);
    lines.push(`${key}: ${truncate(strVal, 200)}`);
  }
```

Replace with:
```typescript
  const lines: string[] = [];
  for (const [key, value] of Object.entries(params)) {
    if (INTERNAL_PARAMS.has(key)) continue;
    if (value == null || value === "") continue;
    const strVal =
      typeof value === "string"
        ? value
        : JSON.stringify(value);
    lines.push(`${key}: ${truncate(strVal, 200)}`);
  }
```

**Verify:**

- `cd /Users/carze/Documents/personal/misc/agentsview/frontend && npx tsc --noEmit 2>&1 | head -20` — no errors
- The `INTERNAL_PARAMS.has(key)` check is present before the null/empty check in the loop.

**Done when:** File compiles cleanly with `agent__intent` filtered from the generic loop.

## Task 3 — Add Tests for `agent__intent` Filtering

**Type:** edit
**Files:**
- `frontend/src/lib/utils/tool-params.test.ts`

**Action:**

Add a new describe block at the end of the file testing that `agent__intent` is filtered from `generateFallbackContent`:

```typescript
describe("generateFallbackContent - agent__intent filtering", () => {
  it("does not include agent__intent in generic key-value output", () => {
    const result = generateFallbackContent("CustomTool", {
      command: "ls -la",
      agent__intent: "Listing files in directory",
    });
    expect(result).not.toContain("agent__intent");
    expect(result).toContain("command: ls -la");
  });

  it("does not include agent__intent for bash tool", () => {
    const result = generateFallbackContent("Bash", {
      command: "npm test",
      agent__intent: "Running test suite",
    });
    // Bash has no special handler for command; falls to generic loop
    // agent__intent must not appear; command may appear
    expect(result).not.toContain("agent__intent");
  });

  it("does not include agent__intent for read tool (generic path)", () => {
    const result = generateFallbackContent("Read", {
      path: "/src/app.ts",
      agent__intent: "Reading auth module",
    });
    expect(result).not.toContain("agent__intent");
  });

  it("returns null when only agent__intent is present", () => {
    const result = generateFallbackContent("CustomTool", {
      agent__intent: "Doing something",
    });
    expect(result).toBeNull();
  });

  it("shows other params when agent__intent is mixed in", () => {
    const result = generateFallbackContent("CustomTool", {
      foo: "bar",
      agent__intent: "Something",
      baz: "qux",
    });
    expect(result).toBe("foo: bar\nbaz: qux");
    expect(result).not.toContain("agent__intent");
  });
});
```

**Verify:**

Run the tool-params test file:
```bash
cd /Users/carze/Documents/personal/misc/agentsview/frontend && npm test -- --run src/lib/utils/tool-params.test.ts 2>&1 | tail -30
```

All tests must pass including the new describe block.

**Done when:** All tool-params tests pass including the five new `agent__intent` filtering tests.

## Verification

```bash
# TypeScript compilation check (all frontend files)
cd /Users/carze/Documents/personal/misc/agentsview/frontend && npx tsc --noEmit 2>&1 | head -20

# Run tool-params tests
cd /Users/carze/Documents/personal/misc/agentsview/frontend && npm test -- --run src/lib/utils/tool-params.test.ts 2>&1 | tail -30

# Run full frontend test suite
cd /Users/carze/Documents/personal/misc/agentsview/frontend && npm test -- --run 2>&1 | tail -20
```

Expected: zero TypeScript errors; all tests pass.

## Success Criteria

- [ ] `ToolBlock.svelte` `inputParams` is derived before `previewLine`
- [ ] `ToolBlock.svelte` `previewLine` uses `$derived.by()` and falls back to `inputParams?.agent__intent` when `content` is empty
- [ ] `tool-params.ts` `INTERNAL_PARAMS` constant exists containing `"agent__intent"`
- [ ] `generateFallbackContent` generic loop skips keys in `INTERNAL_PARAMS`
- [ ] All existing tool-params tests pass
- [ ] New `agent__intent` filtering tests pass (5 tests)
- [ ] TypeScript compiles without errors

## Output

Modified files:
- `frontend/src/lib/components/content/ToolBlock.svelte` — `inputParams`/`previewLine` reorder + `agent__intent` fallback
- `frontend/src/lib/utils/tool-params.ts` — `INTERNAL_PARAMS` constant + filter in generic loop
- `frontend/src/lib/utils/tool-params.test.ts` — new `agent__intent` filtering describe block

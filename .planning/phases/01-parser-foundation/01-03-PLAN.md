---
phase: 01-parser-foundation
plan: "03"
type: tdd
wave: 3
depends_on:
  - "01-01"
  - "01-02"
files_modified:
  - internal/parser/testdata/pi/session.jsonl
  - internal/parser/pi_test.go
autonomous: true
requirements:
  - TEST-01
must_haves:
  truths:
    - "All table-driven subtests in pi_test.go pass with go test -tags fts5"
    - "Fixture file at testdata/pi/session.jsonl covers all required entry types"
    - "Tests pass in CI without pi installed (fixture is synthesized, no real pi files needed)"
  artifacts:
    - path: "internal/parser/testdata/pi/session.jsonl"
      provides: "synthesized pi JSONL fixture covering all message types"
      contains: "session"
    - path: "internal/parser/pi_test.go"
      provides: "table-driven unit tests for ParsePiSession"
      min_lines: 80
  key_links:
    - from: "internal/parser/pi_test.go"
      to: "internal/parser/testdata/pi/session.jsonl"
      via: "loadFixture(t, \"pi/session.jsonl\")"
      pattern: "loadFixture"
    - from: "internal/parser/pi_test.go"
      to: "internal/parser/pi.go"
      via: "ParsePiSession call"
      pattern: "ParsePiSession"
---

<objective>
Write the synthesized fixture file and table-driven unit tests for `ParsePiSession`, covering all required parser behaviors from PRSR-01 through PRSR-10.

Purpose: Verifies the parser is correct across all message types and edge cases. Tests must pass in CI without pi installed (fixture is committed, not read from a real pi installation).
Output: `internal/parser/testdata/pi/session.jsonl` fixture + `internal/parser/pi_test.go` test file.
</objective>

<execution_context>
@/Users/carze/.claude/get-shit-done/workflows/execute-plan.md
@/Users/carze/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-parser-foundation/01-RESEARCH.md
@.planning/phases/01-parser-foundation/01-CONTEXT.md
@.planning/phases/01-parser-foundation/01-01-SUMMARY.md
@.planning/phases/01-parser-foundation/01-02-SUMMARY.md

<interfaces>
<!-- Helpers available in the parser test package (package parser, _test files). -->

From internal/parser/claude_parser_test.go:
```go
// loadFixture reads testdata/{name} relative to the parser package directory.
// Available to pi_test.go because same package.
func loadFixture(t *testing.T, name string) string
```

From internal/parser/parser_test.go:
```go
// createTestFile creates a temp file with content and registers cleanup.
func createTestFile(t *testing.T, name, content string) string
```

From internal/parser/test_helpers_test.go:
```go
// Timestamp constants
const (
    tsZero    = "2024-01-01T00:00:00Z"
    tsEarly   = "2024-01-01T10:00:00Z"
    tsEarlyS1 = "2024-01-01T10:00:01Z"
    tsEarlyS5 = "2024-01-01T10:00:05Z"
    tsLate    = "2024-01-01T10:01:00Z"
)

// Assertion helpers
func assertSessionMeta(t *testing.T, s *ParsedSession, wantID, wantProject string, wantAgent AgentType)
func assertMessage(t *testing.T, m ParsedMessage, wantRole RoleType, wantContentSnippet string)
func assertMessageCount(t *testing.T, count, want int)
func assertTimestamp(t *testing.T, got time.Time, want time.Time)
func assertToolCalls(t *testing.T, got, want []ParsedToolCall)
func assertToolCall(t *testing.T, i int, got, want ParsedToolCall)
```

From internal/parser/types.go (produced by 01-02):
```go
AgentPi       AgentType = "pi"
RoleUser      RoleType = "user"
RoleAssistant RoleType = "assistant"
```

From internal/parser/pi.go (produced by 01-01):
```go
func ParsePiSession(path, project, machine string) (*ParsedSession, []ParsedMessage, error)
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create testdata/pi/session.jsonl fixture</name>
  <files>internal/parser/testdata/pi/session.jsonl</files>
  <action>
    Create the directory `internal/parser/testdata/pi/` and write a synthesized JSONL fixture that covers ALL of the following behaviors in a single file (per locked decision from CONTEXT.md). Each line is a complete JSON object.

    The fixture MUST include:
    1. **Session header** (line 1) — V2 with `id`, `cwd`, `timestamp`, `branchedFrom`
    2. **User message** — content as array `[{"type":"text","text":"..."}]`
    3. **Assistant message with thinking + text + toolCall** — exercises PRSR-03, PRSR-04, PRSR-06
    4. **Tool result message** (role="toolResult") — exercises PRSR-05
    5. **model_change entry** — exercises PRSR-07
    6. **compaction entry with non-empty summary** — exercises PRSR-08
    7. **Second user message** (after compaction, to test timeline continuity)
    8. **Assistant message with redacted thinking** — thinking block has empty `thinking` field but non-empty `thinkingSignature` — exercises PRSR-06 redacted path
    9. **thinking_level_change entry** — must be skipped silently
    10. **A malformed JSON line** — `not valid json -- should be skipped` — exercises silent skip
    11. **An unknown future entry type** — e.g., `{"type":"unknown_future_type","id":"x"}` — exercises silent skip

    Use these values for fixture fields:
    - Session ID: `"pi-test-session-uuid"`
    - Session timestamp: `"2025-01-01T10:00:00Z"`
    - cwd: `"/Users/alice/code/my-project"` (ExtractProjectFromCwd will extract "my-project")
    - branchedFrom: `"/Users/alice/.pi/agent/sessions/--path--/2025-01-01T09-00-00-000Z_parent-uuid.jsonl"`
    - Entry IDs: `"entry-1"`, `"entry-2"`, etc. (sequential)
    - Tool call: name=`"read"`, id=`"toolu_01"`, arguments=`{"file_path":"auth.go"}`
    - model_change: provider=`"anthropic"`, modelId=`"claude-opus-4-5"`
    - compaction summary: `"# Context Checkpoint\nThe user is fixing a login bug."`

    The file must be valid UTF-8 with one JSON object per line. The malformed line is intentionally not valid JSON and must appear as a raw text line (not inside a JSON string).

    Full fixture content (write exactly this, preserving all field names and values):
    ```jsonl
    {"type":"session","version":3,"id":"pi-test-session-uuid","timestamp":"2025-01-01T10:00:00Z","cwd":"/Users/alice/code/my-project","branchedFrom":"/Users/alice/.pi/agent/sessions/--path--/2025-01-01T09-00-00-000Z_parent-uuid.jsonl"}
    {"type":"message","id":"entry-1","parentId":null,"timestamp":"2025-01-01T10:00:01Z","message":{"role":"user","content":[{"type":"text","text":"Fix the login bug"}],"timestamp":1735725601000}}
    {"type":"message","id":"entry-2","parentId":"entry-1","timestamp":"2025-01-01T10:00:02Z","message":{"role":"assistant","content":[{"type":"thinking","thinking":"Let me analyze this carefully.","thinkingSignature":"sig-abc","redacted":false},{"type":"text","text":"Looking at the auth module."},{"type":"toolCall","id":"toolu_01","name":"read","arguments":{"file_path":"auth.go"}}],"model":"claude-opus-4-5","provider":"anthropic","usage":{"input":100,"output":50,"totalTokens":150,"cost":{"total":0.01}},"stopReason":"toolUse","timestamp":1735725602000}}
    {"type":"message","id":"entry-3","parentId":"entry-2","timestamp":"2025-01-01T10:00:03Z","message":{"role":"toolResult","toolCallId":"toolu_01","toolName":"read","content":[{"type":"text","text":"package auth\nfunc Login() {}"}],"isError":false,"timestamp":1735725603000}}
    {"type":"model_change","id":"entry-4","parentId":"entry-3","timestamp":"2025-01-01T10:00:04Z","provider":"anthropic","modelId":"claude-opus-4-5"}
    {"type":"compaction","id":"entry-5","parentId":"entry-4","timestamp":"2025-01-01T10:00:05Z","summary":"# Context Checkpoint\nThe user is fixing a login bug.","firstKeptEntryIndex":0,"tokensBefore":5000}
    {"type":"message","id":"entry-6","parentId":"entry-5","timestamp":"2025-01-01T10:00:06Z","message":{"role":"user","content":[{"type":"text","text":"Look good to you?"}],"timestamp":1735725606000}}
    {"type":"message","id":"entry-7","parentId":"entry-6","timestamp":"2025-01-01T10:00:07Z","message":{"role":"assistant","content":[{"type":"thinking","thinking":"","thinkingSignature":"redacted-sig-xyz","redacted":true},{"type":"text","text":"Looks good!"}],"model":"claude-opus-4-5","provider":"anthropic","usage":{"input":200,"output":10,"totalTokens":210,"cost":{"total":0.005}},"stopReason":"stop","timestamp":1735725607000}}
    {"type":"thinking_level_change","id":"entry-8","parentId":"entry-7","timestamp":"2025-01-01T10:00:08Z","thinkingLevel":"high"}
    not valid json -- malformed line that should be skipped silently
    {"type":"unknown_future_entry_type","id":"entry-9","parentId":"entry-8","timestamp":"2025-01-01T10:00:09Z"}
    ```
  </action>
  <verify>
    <automated>test -f /Users/carze/Documents/personal/misc/agentsview/internal/parser/testdata/pi/session.jsonl && echo "fixture exists"</automated>
  </verify>
  <done>
    File `internal/parser/testdata/pi/session.jsonl` exists with 11 lines covering all required entry types. The file can be loaded by `loadFixture(t, "pi/session.jsonl")`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write table-driven tests in pi_test.go</name>
  <files>internal/parser/pi_test.go</files>
  <action>
    Create `internal/parser/pi_test.go` in `package parser`. Write table-driven unit tests using `testing`, `github.com/stretchr/testify/assert`, and `github.com/stretchr/testify/require`. Use `loadFixture`, `createTestFile`, and the assertion helpers already available in the package.

    **Required test functions (all must be present):**

    **1. TestParsePiSession_SessionHeader** — loads the fixture, verifies session-level fields:
    - `sess.ID == "pi-test-session-uuid"` (PRSR-01)
    - `sess.Agent == AgentPi` (PRSR-11)
    - `sess.Project == "my-project"` (extracted from cwd by ExtractProjectFromCwd) (PRSR-01)
    - `sess.ParentSessionID == "2025-01-01T09-00-00-000Z_parent-uuid"` (PRSR-10)
    - `sess.MessageCount > 0` (PRSR-01)
    - `sess.StartedAt` is non-zero (PRSR-01)

    **2. TestParsePiSession_UserMessages** — verifies user messages:
    - Message at index 0 has role=user, content contains "Fix the login bug" (PRSR-02)
    - `sess.FirstMessage` contains "Fix the login bug" (PRSR-01)
    - Ordinal of first user message is 0

    **3. TestParsePiSession_AssistantMessages** — verifies assistant message with thinking + text + tool call:
    - Find the assistant message (entry-2); verify role=assistant (PRSR-03)
    - `HasThinking == true` (PRSR-06)
    - `HasToolUse == true` (PRSR-03, PRSR-04)
    - `len(ToolCalls) == 1` (PRSR-04)
    - `ToolCalls[0].ToolName == "read"` (PRSR-04)
    - `ToolCalls[0].Category == "Read"` (PRSR-04 + TAXO-01 via NormalizeToolCategory)
    - `ToolCalls[0].ToolUseID == "toolu_01"` (PRSR-04)
    - `ToolCalls[0].InputJSON` contains `"auth.go"` (PRSR-04)
    - Content contains "Looking at the auth module."

    **4. TestParsePiSession_ToolResults** — verifies tool result entry:
    - Find message with non-empty ToolResults (entry-3)
    - `len(msg.ToolResults) == 1` (PRSR-05)
    - `msg.ToolResults[0].ToolUseID == "toolu_01"` (PRSR-05)
    - `msg.ToolResults[0].ContentLength > 0` (PRSR-05)
    - `msg.Role == RoleUser` (matches Claude tool result pattern)

    **5. TestParsePiSession_ThinkingBlocks** — sub-tests:
    - `t.Run("explicit thinking")`: entry-2 assistant message has `HasThinking=true`, content includes the thinking text
    - `t.Run("redacted thinking")`: entry-7 assistant message has `HasThinking=true` even though `thinking` field is empty (`redacted:true`, `thinkingSignature` non-empty) (PRSR-06)

    **6. TestParsePiSession_ModelChange** — verifies model_change synthetic message:
    - A message exists with content `"Model changed to anthropic/claude-opus-4-5"` (PRSR-07)
    - Role is `RoleUser`

    **7. TestParsePiSession_Compaction** — verifies compaction synthetic user message:
    - A message exists with content containing `"Context Checkpoint"` (from the summary) (PRSR-08)
    - Role is `RoleUser`

    **8. TestParsePiSession_SilentSkips** — verifies no errors and no panics from:
    - The malformed JSON line
    - The `thinking_level_change` entry
    - The `unknown_future_entry_type` entry
    - Test: `require.NoError(t, err)` — parser must succeed on the fixture despite these lines

    **9. TestParsePiSession_V1Session** — creates an in-memory JSONL without any `id` field:
    - Use `createTestFile` to write a minimal V1 fixture (no `id` in header, no `id` in message entries)
    - V1 fixture header: `{"type":"session","timestamp":"2025-01-01T10:00:00Z","cwd":"/Users/alice/code/v1-project"}`
    - V1 message: `{"type":"message","timestamp":"2025-01-01T10:00:01Z","message":{"role":"user","content":[{"type":"text","text":"hello"}]}}`
    - Name the test file `"v1-session.jsonl"` so the session ID becomes `"v1-session"` (PRSR-09)
    - Assert `sess.ID == "v1-session"`

    **10. TestParsePiSession_BranchedFrom** — already covered in TestParsePiSession_SessionHeader, but add a focused sub-test asserting the exact `ParentSessionID` value (PRSR-10):
    - `sess.ParentSessionID == "2025-01-01T09-00-00-000Z_parent-uuid"` (basename of branchedFrom without `.jsonl` extension)

    **11. TestParsePiSession_ErrorCases** — sub-tests:
    - `t.Run("missing file")`: `ParsePiSession("/nonexistent.jsonl", ...)` returns error
    - `t.Run("empty file")`: empty file returns error (no session header)
    - `t.Run("not a pi session")`: file with first line `{"type":"message",...}` (not "session") returns error

    **Test helper within pi_test.go:**
    ```go
    func runPiParserTest(t *testing.T, content string) (*ParsedSession, []ParsedMessage) {
        t.Helper()
        path := createTestFile(t, "pi-session.jsonl", content)
        sess, msgs, err := ParsePiSession(path, "my_project", "local")
        require.NoError(t, err)
        return sess, msgs
    }
    ```

    **Imports needed:** `"testing"`, `"strings"`, `"github.com/stretchr/testify/assert"`, `"github.com/stretchr/testify/require"`
  </action>
  <verify>
    <automated>cd /Users/carze/Documents/personal/misc/agentsview && CGO_ENABLED=1 go test -tags fts5 -run TestParsePiSession ./internal/parser/... -v 2>&1 | tail -30</automated>
  </verify>
  <done>
    - All `TestParsePiSession_*` tests pass
    - No test is skipped
    - Coverage includes: session header, user messages, assistant messages, tool calls, tool results, thinking (explicit + redacted), model_change, compaction, silent skips, V1 sessions, branchedFrom, error cases
    - `go test -tags fts5 ./internal/parser/...` passes with no failures
  </done>
</task>

</tasks>

<verification>
Run the full parser test suite:

```bash
cd /Users/carze/Documents/personal/misc/agentsview && CGO_ENABLED=1 go test -tags fts5 ./internal/parser/... -v 2>&1 | grep -E "PASS|FAIL|SKIP"
```

Expected: all tests PASS, none FAIL or SKIP.
</verification>

<success_criteria>
- `internal/parser/testdata/pi/session.jsonl` exists with all required entry types
- `internal/parser/pi_test.go` exists with 11 test functions covering every requirement in TEST-01
- All tests pass: `CGO_ENABLED=1 go test -tags fts5 ./internal/parser/...`
- Tests require no pi installation — fixture is synthesized and committed
- The full existing parser test suite still passes (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/01-parser-foundation/01-03-SUMMARY.md`
</output>

name: MSYS2 Update Check

# Periodically run Windows CI with MSYS2 updates enabled to catch
# toolchain drift, security fixes, and package metadata changes.
# If this workflow fails, update the pinned SHA and packages in ci.yml.

on:
  schedule:
    - cron: "0 9 * * 1"  # Every Monday at 09:00 UTC
  workflow_dispatch:

jobs:
  windows-update-check:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          persist-credentials: false

      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5  # v6.2.0
        with:
          go-version-file: go.mod

      - name: Setup MinGW (with updates)
        uses: msys2/setup-msys2@4f806de0a5a7294ffabaff804b38a9b435a73bda  # v2
        with:
          msystem: MINGW64
          update: true
          install: mingw-w64-x86_64-gcc
          path-type: inherit

      - name: Stub frontend embed dir
        run: mkdir -p internal/web/dist && echo ok > internal/web/dist/stub.html

      - name: Run Go tests
        run: go test -tags fts5 ./... -v -count=1
        env:
          CGO_ENABLED: "1"
